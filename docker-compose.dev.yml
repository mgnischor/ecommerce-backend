version: "3.8"

services:
    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: ecommerce-postgres-dev
        environment:
            POSTGRES_USER: ecommerce
            POSTGRES_PASSWORD: ecommerce
            POSTGRES_DB: ecommerce
        ports:
            - "5432:5432"
        volumes:
            - postgres-dev-data:/var/lib/postgresql/data
        networks:
            - ecommerce-network-dev
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ecommerce"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Jaeger - Distributed Tracing
    jaeger:
        image: jaegertracing/all-in-one:latest
        container_name: ecommerce-jaeger-dev
        environment:
            - COLLECTOR_OTLP_ENABLED=true
            - LOG_LEVEL=debug
        ports:
            - "16686:16686" # Jaeger UI
            - "4317:4317" # OTLP gRPC receiver
            - "4318:4318" # OTLP HTTP receiver
            - "14250:14250" # Jaeger gRPC
            - "14268:14268" # Jaeger HTTP
        networks:
            - ecommerce-network-dev

    # E-Commerce Backend API - Development Mode
    ecommerce-backend-dev:
        build:
            context: .
            dockerfile: Dockerfile
            target: development
            args:
                BUILD_DEVELOPMENT: 1
        container_name: ecommerce-backend-dev
        environment:
            - ASPNETCORE_ENVIRONMENT=Development
            - ASPNETCORE_URLS=http://+:5049
            - ConnectionStrings__DefaultConnection=Host=postgres;Database=ecommerce;Username=ecommerce;Password=ecommerce;Port=5432
            - OpenTelemetry__ServiceName=ECommerce.Backend.Dev
            - OpenTelemetry__ServiceVersion=0.0.10
            - OpenTelemetry__EnableConsoleExporter=true
            - OpenTelemetry__OtlpEndpoint=http://jaeger:4317
        ports:
            - "5049:5049"
        depends_on:
            postgres:
                condition: service_healthy
            jaeger:
                condition: service_started
        networks:
            - ecommerce-network-dev
        restart: unless-stopped

volumes:
    postgres-dev-data:
        name: ecommerce-postgres-dev-data

networks:
    ecommerce-network-dev:
        name: ecommerce-network-dev
        driver: bridge
